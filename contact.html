<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kontakt | MAVI Design</title>
  
  <!-- Favicons -->
  <link rel="icon" type="image/png" sizes="32x32" href="./img/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./img/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="./img/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="./img/android-chrome-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="./img/android-chrome-512x512.png">
  
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script src="./js/utils.js"></script>
  <script src="./js/header.js"></script>
  <script src="./js/cart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    html, body {
      font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
    }
    
    .form-input {
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #000;
      box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
    }
    
    .success-message {
      background-color: #f0fdf4;
      border-color: #22c55e;
      color: #15803d;
    }
    
    .error-message {
      background-color: #fef2f2;
      border-color: #ef4444;
      color: #dc2626;
    }
  </style>
</head>
<body class="bg-white min-h-screen flex flex-col">
  <!-- Header -->
  <div id="header-placeholder"></div>

  <!-- Contact Page Content -->
  <main class="flex-1 container mx-auto px-4 py-8 max-w-4xl">
    <div class="text-center mb-12">

      <p class="text-lg text-gray-600 max-w-2xl mx-auto">
        Har du frågor om våra produkter, din beställning eller behöver hjälp? Vi hjälper dig gärna.
        Skicka oss ett meddelande så återkommer vi så snart som möjligt.
      </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
      <!-- Contact Form -->
      <div class="bg-white">
        <h2 class="text-2xl font-semibold text-gray-900 mb-6">Skicka ett meddelande</h2>
        
        <form id="contact-form" class="space-y-6">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label for="firstName" class="block text-sm font-medium text-gray-700 mb-2">Förnamn *</label>
              <input 
                type="text" 
                id="firstName" 
                name="firstName" 
                required 
                class="form-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-black"
                placeholder="Ditt förnamn"
              >
            </div>
            <div>
              <label for="lastName" class="block text-sm font-medium text-gray-700 mb-2">Efternamn *</label>
              <input 
                type="text" 
                id="lastName" 
                name="lastName" 
                required 
                class="form-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-black"
                placeholder="Ditt efternamn"
              >
            </div>
          </div>

          <div>
            <label for="email" class="block text-sm font-medium text-gray-700 mb-2">E-postadress *</label>
            <input 
              type="email" 
              id="email" 
              name="email" 
              required 
              class="form-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-black"
              placeholder="din@email.se"
            >
          </div>

          <div>
            <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">Telefonnummer</label>
            <input 
              type="tel" 
              id="phone" 
              name="phone" 
              class="form-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-black"
              placeholder="070-123 45 67"
            >
          </div>

          <div>
            <label for="subject" class="block text-sm font-medium text-gray-700 mb-2">Ämne *</label>
            <select 
              id="subject" 
              name="subject" 
              required 
              class="form-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-black"
            >
              <option value="">Välj ämne</option>
              <option value="Allmän fråga">Allmän fråga</option>
              <option value="Produktfråga">Produktfråga</option>
              <option value="Beställningsfråga">Beställningsfråga</option>
              <option value="Leverans & frakt">Leverans & frakt</option>
              <option value="Retur & ångerrätt">Retur & ångerrätt</option>
              <option value="Teknisk support">Teknisk support</option>
              <option value="Reklamation">Reklamation</option>
              <option value="Annat">Annat</option>
            </select>
          </div>

          <div>
            <label for="orderNumber" class="block text-sm font-medium text-gray-700 mb-2">Ordernummer (om tillämpligt)</label>
            <input 
              type="text" 
              id="orderNumber" 
              name="orderNumber" 
              class="form-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-black"
              placeholder="t.ex. #12345"
            >
          </div>

          <div>
            <label for="message" class="block text-sm font-medium text-gray-700 mb-2">Meddelande *</label>
            <textarea 
              id="message" 
              name="message" 
              rows="6" 
              required 
              class="form-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-black resize-vertical"
              placeholder="Beskriv din fråga eller ditt ärende så detaljerat som möjligt..."
            ></textarea>
          </div>

          <div>
            <label for="attachments" class="block text-sm font-medium text-gray-700 mb-2">Bifoga bilder (valfritt)</label>
            <div class="relative">
              <input 
                type="file" 
                id="attachments" 
                name="attachments" 
                multiple 
                accept="image/*"
                class="form-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-black file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-50 file:text-gray-700 hover:file:bg-gray-100"
              >
            </div>
            <p class="text-xs text-gray-500 mt-2">
              Du kan bifoga upp till 3 bilder (max 5MB per bild). Accepterade format: JPG, PNG, GIF, WEBP
            </p>
            <div id="file-preview" class="mt-3 grid grid-cols-2 sm:grid-cols-3 gap-3 hidden">
              <!-- File previews will be shown here -->
            </div>
          </div>

          <!-- Success/Error Messages -->
          <div id="form-message" class="hidden p-4 rounded-lg border"></div>

          <button 
            type="submit" 
            id="submit-btn"
            class="w-full bg-black text-white py-4 px-6 rounded-lg font-semibold hover:bg-gray-900 transition duration-200 focus:outline-none focus:ring-2 focus:ring-black focus:ring-offset-2"
          >
            <span id="submit-text">Skicka meddelande</span>
            <span id="submit-loading" class="hidden">
              <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Skickar...
            </span>
          </button>

          <p class="text-sm text-gray-500 text-center">
            * Obligatoriska fält. Vi återkommer vanligtvis inom 24 timmar.
          </p>
        </form>
      </div>

      <!-- Contact Information -->
      <div class="bg-gray-50 p-8 rounded-xl">
        <h2 class="text-2xl font-semibold text-gray-900 mb-6">Kontaktinformation</h2>
        
        <div class="space-y-6">
          <div class="flex items-start space-x-4">
            <div class="flex-shrink-0">
              <svg class="w-6 h-6 text-gray-600 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
              </svg>
            </div>
            <div>
              <h3 class="font-semibold text-gray-900">E-post</h3>
              <p class="text-gray-600">info@mavidesign.se</p>
            </div>
          </div>

          <div class="flex items-start space-x-4">
            <div class="flex-shrink-0">
              <svg class="w-6 h-6 text-gray-600 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <div>
              <h3 class="font-semibold text-gray-900">Svarstider</h3>
              <p class="text-gray-600">Måndag - Fredag: Inom 24 timmar</p>
              <p class="text-gray-600">Helger: Inom 48 timmar</p>
            </div>
          </div>

          <div class="flex items-start space-x-4">
            <div class="flex-shrink-0">
              <svg class="w-6 h-6 text-gray-600 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <div>
              <h3 class="font-semibold text-gray-900">Vanliga frågor</h3>
              <ul class="text-gray-600 space-y-1 mt-2">
                <li>• Produktinformation och specifikationer</li>
                <li>• Beställningsstatus och leveranstider</li>
                <li>• Retur och ångerrätt</li>
                <li>• Teknisk support</li>
                <li>• Företagsförsäljning</li>
              </ul>
            </div>
          </div>

          <div class="bg-white p-6 rounded-lg border border-gray-200">
            <h3 class="font-semibold text-gray-900 mb-3">Tips för snabbare service</h3>
            <ul class="text-sm text-gray-600 space-y-2">
              <li>• Inkludera ditt ordernummer om du har en</li>
              <li>• Beskriv ditt ärende så detaljerat som möjligt</li>
              <li>• Bifoga tydliga bilder vid reklamationer eller produktfrågor</li>
              <li>• Ange önskad kontaktmetod</li>
              <li>• För tekniska problem - beskriv vad du försökte göra</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Cart Drawer -->
  <div id="cart-backdrop" class="fixed inset-0 z-40 hidden" style="background: rgba(255,255,255,0.4);"></div>
  <div id="cart-drawer" class="fixed top-0 right-0 h-full w-full max-w-xl bg-white shadow-xl z-50 transform translate-x-full transition-transform duration-300 flex flex-col" style="width:40vw; min-width:320px;">
    <div class="flex items-center justify-between p-6 border-b">
      <h2 class="text-lg font-semibold">Din varukorg</h2>
      <button id="cart-close" class="text-gray-400 hover:text-gray-600">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div class="flex-1 overflow-y-auto">
      <div id="cart-items" class="p-6">
        <!-- Cart items will be populated here -->
      </div>
    </div>
    <div class="border-t p-6">
      <div class="flex justify-between text-lg font-semibold mb-4">
        <span>Totalt:</span>
        <span id="cart-total">0 kr</span>
      </div>
      <button class="w-full bg-black text-white py-3 rounded-lg font-semibold hover:bg-gray-900 transition cursor-pointer">
        Gå till kassan
      </button>
    </div>
  </div>

  <script>
    // Initialize EmailJS with your actual Public Key
    emailjs.init("EXLO5_EZugAYOuHiB"); // Your EmailJS Public Key

    // File handling
    const attachmentsInput = document.getElementById('attachments');
    const filePreview = document.getElementById('file-preview');
    let selectedFiles = [];

    attachmentsInput.addEventListener('change', function(e) {
      const files = Array.from(e.target.files);
      
      // Validate files
      const validFiles = files.filter(file => {
        // Check file type
        if (!file.type.startsWith('image/')) {
          alert(`${file.name} är inte en giltig bildfil.`);
          return false;
        }
        
        // Check file size (5MB limit)
        if (file.size > 5 * 1024 * 1024) {
          alert(`${file.name} är för stor. Max filstorlek är 5MB.`);
          return false;
        }
        
        return true;
      });

      // Limit to 3 files
      if (validFiles.length > 3) {
        alert('Du kan bara bifoga upp till 3 bilder.');
        selectedFiles = validFiles.slice(0, 3);
      } else {
        selectedFiles = validFiles;
      }

      displayFilePreview();
    });

    function displayFilePreview() {
      if (selectedFiles.length === 0) {
        filePreview.classList.add('hidden');
        return;
      }

      filePreview.classList.remove('hidden');
      filePreview.innerHTML = selectedFiles.map((file, index) => {
        const url = URL.createObjectURL(file);
        return `
          <div class="relative">
            <img src="${url}" alt="Preview ${index + 1}" class="w-full h-20 object-cover rounded-lg border border-gray-200">
            <button type="button" onclick="removeFile(${index})" class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full text-xs font-bold hover:bg-red-600 focus:outline-none">
              ×
            </button>
            <p class="text-xs text-gray-500 mt-1 truncate">${file.name}</p>
          </div>
        `;
      }).join('');
    }

    function removeFile(index) {
      selectedFiles.splice(index, 1);
      displayFilePreview();
      
      // Update file input
      const dt = new DataTransfer();
      selectedFiles.forEach(file => dt.items.add(file));
      attachmentsInput.files = dt.files;
    }

    // Convert file to base64
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
      });
    }

    document.getElementById('contact-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submit-btn');
      const submitText = document.getElementById('submit-text');
      const submitLoading = document.getElementById('submit-loading');
      const messageDiv = document.getElementById('form-message');
      
      // Show loading state
      submitBtn.disabled = true;
      submitText.classList.add('hidden');
      submitLoading.classList.remove('hidden');
      messageDiv.classList.add('hidden');
      
      try {
        // Get form data
        const formData = new FormData(this);
        
        // Process attachments
        let attachmentData = '';
        if (selectedFiles.length > 0) {
          const attachmentPromises = selectedFiles.map(async (file, index) => {
            const base64 = await fileToBase64(file);
            return `\n\n--- Bilaga ${index + 1}: ${file.name} ---\n[Bild bifogad - se e-postmeddelandet för full bild]`;
          });
          
          const attachmentTexts = await Promise.all(attachmentPromises);
          attachmentData = attachmentTexts.join('');
        }

        // Create date/time for email
        const now = new Date();
        const orderDate = now.toLocaleDateString('sv-SE');
        const orderTime = now.toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit' });

        const templateParams = {
          // Contact form specific fields
          from_name: `${formData.get('firstName')} ${formData.get('lastName')}`,
          from_email: formData.get('email'),
          phone: formData.get('phone') || 'Ej angivet',
          subject: formData.get('subject'),
          order_number: formData.get('orderNumber') || null,
          message: formData.get('message') + attachmentData,
          attachments_count: selectedFiles.length,
          
          // Shared fields (reuse for date/time)
          order_date: orderDate,
          order_time: orderTime,
          
          // Order fields set to null/empty (so template knows this is a contact form)
          order_items: null,
          customer_name: null,
          customer_email: null,
          customer_address: null,
          customer_postal_code: null,
          customer_city: null,
          order_total: null
        };

        // Add base64 attachments to template params for EmailJS (only if files exist)
        if (selectedFiles.length > 0) {
          for (let i = 0; i < selectedFiles.length; i++) {
            const base64 = await fileToBase64(selectedFiles[i]);
            templateParams[`attachment_${i + 1}`] = base64;
            templateParams[`attachment_${i + 1}_name`] = selectedFiles[i].name;
          }
        }

        // Send email using EmailJS
        await emailjs.send(
          'service_a599pmp', // Your Gmail Service ID
          'template_247sx9d', // Your order template ID
          templateParams,
          'EXLO5_EZugAYOuHiB' // Your public key
        );

        // Show success message
        messageDiv.className = 'success-message p-4 rounded-lg border';
        messageDiv.innerHTML = `
          <div class="flex items-center">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <span><strong>Tack för ditt meddelande!</strong> Vi återkommer så snart som möjligt. ${selectedFiles.length > 0 ? `Dina ${selectedFiles.length} bilaga(r) har skickats med.` : ''}</span>
          </div>
        `;
        messageDiv.classList.remove('hidden');

        // Reset form and files
        this.reset();
        selectedFiles = [];
        displayFilePreview();

      } catch (error) {
        // Show error message
        messageDiv.className = 'error-message p-4 rounded-lg border';
        messageDiv.innerHTML = `
          <div class="flex items-start">
            <svg class="w-5 h-5 mr-2 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
            </svg>
            <span><strong>Fel:</strong> Meddelandet kunde inte skickas. Försök igen eller kontakta oss direkt på info@mavidesign.se</span>
          </div>
        `;
        messageDiv.classList.remove('hidden');
      } finally {
        // Reset button state
        submitBtn.disabled = false;
        submitText.classList.remove('hidden');
        submitLoading.classList.add('hidden');
      }
    });
  </script>
</body>
</html>
